name: Release

on:
  push:
    branches:
      - main
    paths:
      - '*.c'
      - '*.h'
      - 'Makefile'
      - 'Dockerfile'
    tags:
      - 'v*'

jobs:
  tag:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    permissions:
      contents: write

    outputs:
      tag: ${{ steps.bump.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Determine next version tag
        id: bump
        run: |
          latest=$(git tag -l 'v*' --sort=-v:refname | head -n1)
          if [ -z "$latest" ]; then
            next="v0.103.1"
          else
            # Extract major.minor.patch â€” handles both v0.103 and v0.103.1
            base="${latest#v}"
            IFS='.' read -r major minor patch <<< "$base"
            patch=${patch:-0}
            next="v${major}.${minor}.$((patch + 1))"
          fi
          echo "tag=$next" >> "$GITHUB_OUTPUT"
          echo "Next version: $next"

      - name: Create and push tag
        env:
          TAG: ${{ steps.bump.outputs.tag }}
        run: |
          git tag "$TAG"
          git push origin "$TAG"

  build:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ${{ matrix.runner }}

    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libusb-1.0-0-dev gcc

      - name: Build
        run: make CC=gcc

      - name: Package binaries
        run: |
          mkdir -p dist
          cp hmland hmsniff flash-hmcfgusb flash-hmmoduart flash-ota dist/
          tar czf hmcfgusb-${{ github.ref_name }}-linux-${{ matrix.arch }}.tar.gz -C dist .

      - name: Upload binary artifact
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: binaries-${{ matrix.arch }}
          path: hmcfgusb-*.tar.gz

  deb:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper libusb-1.0-0-dev

      - name: Build Debian package
        run: dpkg-buildpackage -us -uc -b

      - name: Upload .deb artifact
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: debian-package
          path: ../*.deb

  release:
    needs: [build, deb]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          path: artifacts

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --repo ${{ github.repository }} \
            --generate-notes \
            artifacts/binaries-amd64/*.tar.gz \
            artifacts/binaries-arm64/*.tar.gz \
            artifacts/debian-package/*.deb
