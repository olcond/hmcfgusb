name: Cross-compile

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  cross:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - arch: arm64
            cc: aarch64-linux-gnu-gcc
            pkg: gcc-aarch64-linux-gnu
            dpkg_arch: arm64
          - arch: armhf
            cc: arm-linux-gnueabihf-gcc
            pkg: gcc-arm-linux-gnueabihf
            dpkg_arch: armhf

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Configure apt sources for cross-architecture
        run: |
          sudo dpkg --add-architecture ${{ matrix.dpkg_arch }}
          # Ubuntu 24.04 uses DEB822-format sources; restrict default to amd64
          # and add ports.ubuntu.com for foreign architectures
          sudo sed -i 's/^Types: deb$/&\nArchitectures: amd64/' /etc/apt/sources.list.d/ubuntu.sources
          printf '%s\n' \
            "Types: deb" \
            "URIs: http://ports.ubuntu.com/ubuntu-ports" \
            "Suites: noble noble-updates noble-backports noble-security" \
            "Components: main universe restricted multiverse" \
            "Architectures: armhf arm64" \
            "Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg" \
            | sudo tee /etc/apt/sources.list.d/ports.sources > /dev/null

      - name: Install cross-compiler and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.pkg }} libusb-1.0-0-dev:${{ matrix.dpkg_arch }}

      - name: Cross-compile for ${{ matrix.arch }}
        run: make CC=${{ matrix.cc }} CFLAGS="${CFLAGS} -Werror"
        env:
          CFLAGS: -MMD -O2 -Wall -Wextra -I/opt/local/include -g
